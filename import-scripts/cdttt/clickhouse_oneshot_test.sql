DROP TABLE IF EXISTS genetic_alteration_derived;

CREATE TABLE IF NOT EXISTS genetic_alteration_derived
(
    sample_unique_id String,
    cancer_study_identifier LowCardinality(String),
    hugo_gene_symbol String,
    profile_type LowCardinality(String),
    alteration_value Nullable(String)
    )
    ENGINE = MergeTree()
    ORDER BY (cancer_study_identifier, hugo_gene_symbol, profile_type, sample_unique_id);

INSERT INTO TABLE genetic_alteration_derived
SELECT
    sample_unique_id,
    cancer_study_identifier,
    hugo_gene_symbol,
    replaceOne(stable_id, concat(sd.cancer_study_identifier, '_'), '') as profile_type,
    alteration_value
FROM
    (SELECT
         sample_id,
         hugo_gene_symbol,
         stable_id,
         alteration_value
    FROM
        (SELECT
            g.hugo_gene_symbol AS hugo_gene_symbol,
            gp.stable_id as stable_id,
            arrayMap(x -> (x = '' ? NULL : x), splitByString(',', assumeNotNull(substring(ga.values, 1, -1)))) AS alteration_value,
            arrayMap(x -> (x = '' ? NULL : toInt32(x)), splitByString(',', assumeNotNull(substring(gps.ordered_sample_list, 1, -1)))) AS sample_id
        FROM
            genetic_alteration ga
            JOIN genetic_profile gp ON ga.genetic_profile_id=gp.genetic_profile_id
            JOIN genetic_profile_samples gps ON gp.genetic_profile_id = gps.genetic_profile_id
            JOIN gene g ON ga.genetic_entity_id = g.genetic_entity_id
        WHERE gp.genetic_profile_id IN ('29','38','41','43','45','91','93','108','110','122','123','143','145','188','190','212','214','216','218','219','221','223','224','226','319','321','333','335','337','343','345','347','349','426','428','440','442','467','469','487','489','490','492','493','495','497','508','510','613','615','616','618','619','621','647','649','651','653','656','659','660','662','672','674','695','697','698','700','702','704','705','707','713','715','716','718','779','780','781','782','784','785','786','787','788','790','792','833','835','837','839','840','842','843','845','846','848','1004','1006','1033','1035','1036','1046','1048','1053','1055','1056','1058','1074','1088','1095','1096','1097','1098','1099','1100','1101','1103','1104','1105','1106','1107','1108','1109','1111','1112','1113','1114','1115','1116','1118','1119','1120','1121','1122','1123','1124','1126','1127','1128','1129','1130','1131','1133','1134','1135','1136','1137','1138','1173','1174','1176','1177','1179','1180','1182','1194','1196','1197','1235','1237','1239','1241','1242','1243','1244','1245','1246','1306','1310','1312','1353','1354','1356','1358','1360','1384','1432','1434','1438','1440','1469','1471','1490','1492','1499','1501','1549','1551','1552','1553','1554','1595','1597','1599','1601','1603','1609','1611','1612','1614','1620','1621','1622','1623','1625','1626','1627','1628','1659','1706','1708','1750','1752','1763','1765','1816','1818','1821','1836','1840','1842','1873','1874','1876','1916','1918','1920','1922','1972','1974','1975','1977','1978','1979','1980','1981','1982','1983','1985','1986','1987','1988','1989','1990','1991','1993','1994','1995','1996','1997','1998','1999','2001','2002','2003','2004','2005','2006','2007','2009','2010','2011','2012','2013','2014','2015','2017','2018','2019','2020','2021','2022','2023','2025','2026','2027','2028','2029','2030','2031','2033','2034','2035','2036','2037','2038','2039','2041','2042','2043','2044','2045','2046','2047','2049','2050','2051','2052','2053','2054','2055','2057','2058','2059','2060','2061','2062','2063','2065','2066','2067','2068','2069','2070','2071','2073','2074','2075','2076','2077','2078','2079','2081','2082','2083','2084','2085','2086','2087','2089','2090','2091','2092','2093','2094','2095','2097','2098','2099','2100','2101','2102','2103','2105','2106','2107','2108','2109','2110','2111','2113','2114','2115','2116','2117','2118','2119','2121','2122','2123','2124','2125','2126','2127','2129','2130','2131','2132','2133','2134','2135','2137','2138','2139','2140','2141','2142','2143','2145','2146','2147','2148','2149','2150','2151','2153','2154','2155','2156','2157','2158','2159','2161','2162','2163','2164','2165','2166','2167','2169','2170','2171','2172','2173','2174','2175','2177','2178','2179','2180','2181','2182','2183','2185','2186','2187','2188','2189','2190','2191','2193','2194','2195','2196','2197','2198','2199','2201','2202','2203','2204','2205','2206','2207','2209','2210','2211','2212','2213','2214','2215','2217','2218','2219','2220','2221','2222','2231','2233','2234','2235','2236','2237','2238','2239','2241','2242','2243','2244','2245','2246','2248','2249','2250','2251','2252','2253','2255','2256','2257','2258','2259','2260','2261','2263','2264','2265','2266','2267','2268','2269','2271','2272','2273','2274','2275','2276','2277','2279','2280','2281','2282','2283','2284','2286','2287','2288','2289','2290','2291','2292','2294','2295','2296','2297','2298','2299','2300','2302','2303','2304','2305','2306','2307','2308','2310','2311','2312','2313','2314','2315','2324','2326','2327','2329','2330','2331','2332','2333','2334','2345','2347','2349','2351','2352','2354','2355','2356','2358','2366','2368','2373','2375','2376','2381','2382','2383','2384','2386','2387','2388','2389','2390','2391','2392','2393','2442','2444','2448','2458','2473','2475','2538','2539','2540','2541','2543','2544','2545','2546','2547','2548','2549','2550','2552','2553','2554','2555','2559','2560','2561','2562','2563','2566','2567','2568','2569','2571','2572','2573','2574','2575','2577','2579','2581','2582','2584','2585','2587','2589','2590','2591','2592','2593','2594','2595','2596','2597','2599','2600','2601','2602','2603','2604','2605','2606','2607','2608','2610','2611','2612','2613','2626','2627','2628','2629','2630','2632','2633','2634','2635','2636','2637','2638','2639','2640','2643','2644','2645','2646','2647','2648','2650','2652','2653','2655','2656','2657','2658','2660','2661','2662','2663','2664','2665','2666','2667','2668','2670','2671','2672','2673','2674','2675','2677','2678','2679','2680','2682','2683','2684','2686','2687','2688','2689','2690','2692','2693','2694','2695','2697','2699','2701','2702','2703','2704','2705','2706','2707','2709','2710','2711','2712','2713','2714','2715','2716','2717','2718','2719','2721','2722','2723','2724','2725','2726','2727','2728','2730','2731','2732','2733','2735','2736','2737','2738','2740','2741','2742','2743','2744','2745','2746','2747','2748','2749','2750','2751','2753','2754','2755','2756','2757','2758','2759','2760','2761','2763','2764','2765','2768','2770','2771','2773','2775','2777','2778','2779','2782','2783','2784','2786','2787','2788','2789','2790','2791','2792','2793','2794','2795','2797','2798','2799','2800','2801','2802','2803','2804','2805','2806','2807','2808','2810','2811','2812','2813','2814','2815','2816','2817','2818','2819','2820','2822','2823','2824','2825','2826','2827','2828','2829','2830','2831','2833','2834','2835','2836','2837','2838','2839','2840','2841','2842','2843','2844','2846','2847','2848','2850','2851','2853','2855','2856','2857','2858','2859','2860','2861','2862','2863','2864','2866','2867','2868','2869','2870','2871','2872','2873','2874','2875','2876','2878','2879','2880','2881','2882','2883','2885','2886','2887','2888','2889','2890','2891','2892','2893','2894','2898','2899','2900','2901','2902','2903','2904','2906','2907','2908','2909','2910','2911','2912','2913','2914','2915','2916','2917','2919','2920','2921','2922','2923','2924','2926','2927','2929','2930','2933','2934','2935','2936','2938','2940','2941','2942','2943','2944','2945','2947','2948','2949','2950','2953','2956','2957','2958','2959','2960','2962','2963','2964','2965','2966','2967','2968','2969','2971','2972','2974','2975','2976','2977','2979','2980','2981','2982','2983','2984','2985','2986','2987','2988','2989','2991','2992','2994','2995','2996','2997','2998','2999','3000','3001','3002','3003','3004','3006','3007','3008','3009','3010','3011','3012','3013','3015','3016','3017','3018','3019','3020','3021','3022','3024','3025','3026','3027','3028','3029','3030','3031','3032','3034','3035','3036','3037','3038','3039','3040','3041','3042','3043','3044','3045','3046','3048','3049','3050','3051','3052','3054','3055','3056','3057','3058','3059','3060','3061','3062','3063','3064','3065','3067','3068','3069','3070','3071','3072','3073','3074','3076','3077','3078','3079','3080','3081','3082','3083','3085','3086','3087','3088','3089','3090','3091','3092','3093','3094','3095','3096','3097','3099','3100','3101','3102','3107','3110','3111','3112','3114','3115','3116','3118','3119','3120','3121','3122','3123','3124','3125','3126','3127','3128','3129','3131','3132','3133','3134','3135','3136','3137','3138','3139','3141','3142','3143','3144','3145','3146','3147','3148','3150','3151','3152','3153','3154','3155','3156','3157','3158','3159','3161','3162','3163','3164','3165','3166','3168','3169','3171','3174','3176','3178','3179','3181','3182','3184','3185','3186','3187','3189','3190','3191','3192','3193','3195','3196','3197','3198','3199','3200','3201','3202','3203','3204','3206','3207','3208','3209','3210','3211','3212','3213','3214','3215','3216','3217','3218','3219','3220','3222','3223','3224','3225','3226','3227','3228','3229','3231','3232','3233','3234','3235','3236','3237','3238','3239','3240','3241','3243','3244','3245','3246','3247','3248','3249','3250','3251','3252','3254','3256','3258','3260','3261','3263','3264','3265','3266','3268','3269','3270','3272','3274','3276','3277','3279','3281','3282','3283','3285','3286','3291','3292','3293','3294','3296','3297','3298','3299','3301','3302','3303','3305','3306','3307','3308','3309','3310','3311','3313','3314','3315','3316','3318','3322','3323','3324','3325','3326','3327','3328','3330','3331','3332','3333','3334','3335','3336','3337','3338','3339','3340','3341','3342','3343','3345','3346','3347','3348','3350','3351','3352','3354','3355','3356','3357','3358','3359','3360','3363','3365','3367','3368','3370','3372','3374','3375','3378','3380','3382','3384','3386','3387','3388','3389','3390','3391','3393','3394','3395','3397','3398','3399','3400','3401','3402','3403','3404','3405','3406','3407','3409','3410','3411','3412','3413','3414','3415','3416','3418','3419','3420','3421','3422','3423','3425','3426','3427','3428','3430','3431','3432','3433','3434','3436','3437','3439','3440','3441','3443','3444','3445','3446','3447','3448','3450','3451','3452','3453','3454','3455','3456','3457','3459','3460','3461','3462','3463','3465','3466','3468','3469','3470','3471','3472','3473','3475','3476','3477','3478','3479','3481','3482','3484','3485','3486','3487','3488','3489','3490','3492','3493','3494','3496','3497','3498','3499','3501','3503','3504','3505','3507','3508','3510','3511','3513','3514','3515','3516','3517','3518','3519','3520','3521','3522','3523','3525','3526','3528','3529','3530','3531','3532','3534','3535','3536','3537','3539','3540','3541','3543','3544','3545','3546','3547','3548','3549','3551','3552','3553','3554','3555','3556','3557','3558','3560','3561','3562','3563','3564','3565','3566','3567','3568','3569','3570','3571','3573','3574','3575','3576','3577','3578','3579','3580','3582','3583','3584','3585','3586','3587','3588','3590','3591','3592','3593','3594','3595','3596','3597','3599','3600','3601','3602','3603','3604','3605','3606','3607','3608','3609','3610','3612','3613','3614','3615','3616','3617','3619','3620','3621','3622','3625','3629','3630','3632','3633','3634','3635','3639','3640','3641','3642','3643','3645','3646','3647','3648','3649','3651','3652','3653','3654','3656','3657','3658','3659','3660','3661','3662','3663','3666','3668','3669','3670','3671','3673','3674','3675','3678','3679','3680','3681','3682','3683','3685','3686','3687','3688','3689','3690','3691','3692','3696','3697','3698','3700','3701','3702','3704','3705','3706','3707','3709','3710','3711','3713','3714','3715','3716','3717','3718','3720','3721','3722','3723','3724','3725','3728','3731','3732','3733','3734','3735','3737','3738','3739','3740','3741','3742','3743','3744','3745','3746','3747','3748','3750','3751','3752','3753','3754','3755','3756','3757','3758','3759','3760','3761','3763','3764','3765','3766','3767','3768','3769','3770','3771','3772','3773','3774','3776','3777','3778','3779','3780','3781','3782','3783','3784','3785','3787','3788','3789','3790','3791','3792','3793','3794','3795','3796','3798','3799','3800','3801','3802','3803','3804','3805','3806','3807','3808','3810','3811','3812','3813','3814','3815','3816','3817','3818','3819','3820','3821','3823','3824','3825','3826','3827','3828','3829','3830','3831','3832','3833','3834','3836','3837','3838','3839','3840','3841','3842','3843','3844','3845','3846','3847','3849','3850','3851','3852','3853','3854','3855','3856','3857','3858','3859','3860','3861','3862','3864','3865','3866','3867','3868','3869','3870','3871','3872','3873','3874','3876','3877','3878','3879','3880','3881','3882','3883','3884','3885','3886','3888','3889','3890','3891','3892','3893','3894','3895','3896','3897','3898','3900','3901','3902','3903','3904','3905','3906','3907','3908','3909','3910','3911','3913','3914','3915','3916','3917','3918','3920','3921','3922','3923','3924','3925','3927','3928','3929','3930','3931','3932','3933','3934','3935','3936','3937','3939','3940','3941','3942','3943','3944','3945','3946','3947','3948','3949','3950','3952','3953','3954','3955','3956','3957','3958','3959','3960','3961','3962','3964','3965','3966','3967','3968','3969','3970','3971','3972','3973','3974','3975','3977','3978','3979','3980','3981','3982','3983','3984','3985','3986','3987','3989','3990','3991','3992','3993','3994','3995','3996','3997','3998','3999','4000','4002','4003','4004','4005','4006','4007','4008','4009','4010','4011','4012','4014','4015','4016','4017','4018','4019','4020','4022','4023','4033','4034','4035','4036','4037','4039','4040','4041','4042','4043','4044','4048','4050','4057','4059','4060','4062','4063','4065','4070','4072','4073','4075','4077','4087','4089','4090','4092','4100','4109','4110','4111','4113','4117','4119','4121'))
            ARRAY JOIN alteration_value, sample_id
    WHERE alteration_value != 'NA') AS subquery
        JOIN sample_derived sd ON sd.internal_id = subquery.sample_id
    SETTINGS
        async_insert=1,
        wait_for_async_insert=1,
        async_insert_busy_timeout_ms=300000,
        async_insert_max_data_size=4000000000,
        async_insert_max_query_number=10000;

OPTIMIZE TABLE genetic_alteration_derived;
